// Generated by LiveScript 1.5.0
(function(){
  var spawn, path, temp, fs;
  spawn = require('child_process').spawn;
  path = require('path');
  temp = require('temp');
  fs = require('fs');
  module.exports = function(epub, callback){
    temp.track();
    return temp.mkdir('node-kindlegen', function(error, tempDir){
      var inputPath, outputPath;
      if (error) {
        return callback(error);
      }
      inputPath = path.join(tempDir, 'input.epub');
      outputPath = path.join(tempDir, 'output.mobi');
      return fs.writeFile(inputPath, epub, function(error, written, string){
        var kindlegen;
        if (error) {
          return callback(error);
        }
        kindlegen = spawn(path.resolve(__dirname, 'bin/kindlegen'), ['input.epub', '-c2', '-verbose', '-o', 'output.mobi'], {
          cwd: tempDir,
          env: {}
        });
        return kindlegen.on('close', function(code){
          if (code !== 0 && code !== 1) {
            return callback(new Error("kindlegen returned error " + code));
          }
          return fs.readFile(outputPath, function(error, mobi){
            if (error) {
              return callback(error);
            }
            return callback(null, mobi);
          });
        });
      });
    });
  };
}).call(this);
